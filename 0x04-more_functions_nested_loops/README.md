Getting along with more functions, more nested loops
